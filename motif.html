<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>motif search</title>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="./css/base.css"/>
    <link rel="stylesheet" href="./css/tool.css"/>
    <link rel="stylesheet" href="./css/banner.css"/>
    <link rel="stylesheet" href="./css/analysis_detail.css"/>
    <link rel="stylesheet" href="./css/analysis_loading.css" />
    <style type="text/css">
        /* this is the result display part */
        .right-part .pic-box .result-box{
            position:absolute;
            width:100%;
            height:100%;
            text-align:center;
            color:var(--violat);
            font-size:1.6vw;
            padding-top:10%;
            box-sizing: border-box;
            background-color: #fff;
        }
        .right-part .pic-box .result-box b{
            color:var(--dark-blue)
        }
        .right-part .pic-box .result-box div{
            font-size:1.2vw;
            margin-top:4vh;
        }
    </style>
</head>
<body>
        <!-- banner -->
        <header class="banner animate__animated animate__slideInDown">
            <h2 class="gangalin-font">MOTIF SEARCHING</h2>
         </header>
    
         <!-- content part -->
         <section class="content">
            <!-- left part -->
             <ul class="left-part" id="left-part">
                <li id="upload_new" class=" more-sugar-font">
                    <img src="./imgs/heart_box.png" />
                    <label for="fileUpload" class="upload-btn">upload new seq</label>
                    <input type="file" id="fileUpload" name="fileUpload" >
                </li>
                <li id="previous_seq" class=" more-sugar-font">
                    <p>using previous seq</p>
                    <img src="./imgs/heart_box.png" />
                </li>
                <li class="more-sugar-font"><a href="/~s2647596/analysis.html">return</a></li>
             </ul>
             <!-- right part -->
              <div class="right-part">
                <div class="pic-box" id="content-box">
                    <img src="./imgs/motif.png" />    
                </div>
                <div class="word-box more-sugar-font">
                    <img src="./imgs/word_box.png" />
                    <p id="content_box">
                        introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function introduction of this function 
                    </p>
                </div>
              </div>
         </section>
    
         <!-- footer part: return to home page -->
        <a class="return-home sprite-left5 animate__animated animate__slideInUp" href="/~s2647596/index.html"></a>    

    <script type="module">
        // Obtain elements
        const previous_seq_el = document.getElementById("previous_seq");
        const seq_id_url = "/~s2647596/php/seq_id.php";
        const file_el = document.getElementById("fileUpload")
        const content_el = document.getElementById("content-box")
        const left_part_el = document.getElementById("left-part")
        const upload_url = "/~s2647596/php/upload_file.php"
        const motif_url = "/~s2647596/php/motif.php"
    
        //import js files
        import find_prev_seq from "./js/seq_id.js";
        import upload_file from "./js/upload_file.js";
        
        // Use async function to get the stat value
        const getStat = async (func, el, url) => {
            try {
                // Should show "success" or "error" after button click or file upload
                const stat = await func(el, url);
                if(stat == "success"){
                    content_el.innerHTML = `<div class="loading-box more-sugar-font">
                        <img src="./imgs/loading.gif" />
                        <p></p>
                        <p>Motif searching ...</p>
                    </div>`
                    // Perform motif searching request
                    const response = await fetch(motif_url, {
                        method: "post"
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status == "error") {
                            throw new Error(data.message);
                        } else {
                            let display_html = `<div class="result-box more-sugar-font">
                                                        <p>total sequences scanned: <b>${data.total_seq}</b></p>
                                                        <p>sequences with known motifs: <b>${data.motif_seq}</b></p>`
                            if(data.motif_seq<=0){
                                display_html += `<p>did not find matched motifs</p>
                                                <p>please try other sequences</p>
                                                </div>`
                            }else{
                                display_html += `<p>Associated motifs (<b>${data.associated_motif}</b>):</p>
                                                <div>`
                                //obtain the name of each motif
                                for(let motif_name of Object.keys(data.motif_dict)){
                                    //display the motif name and matched sequnece number 
                                    display_html += `<p> *** <b>${motif_name}</b> (${data.motif_dict[motif_name].length} sequences) *** </p> `
                                }
                                display_html += `</div></div>`
                            }
                                                        
                            content_el.innerHTML = display_html
                            left_part_el.innerHTML = `<li class="more-sugar-font zip-download">
                                                            <a href="${data.zip_src}"  download>download results</a>
                                                            <img src="./imgs/heart_box.png" />
                                                        </li>
                                                        <li class="more-sugar-font"><a href="/~s2647596/analysis.html">return</a></li>` 
                        }
                    } else {
                        throw new Error(`http code error: ${response.status}`);
                    }
                }
            } catch (error) {
                alert(error)
                alert("please try again")
                content_el.innerHTML = `<img src="./imgs/motif.png" />`
                left_part_el.innerHTML = `<li id="upload_new" class=" more-sugar-font">
                                            <img src="./imgs/heart_box.png" />
                                            <label for="fileUpload" class="upload-btn">upload new seq</label>
                                            <input type="file" id="fileUpload" name="fileUpload" >
                                        </li>
                                        <li id="previous_seq" class=" more-sugar-font">
                                            <p>using previous seq</p>
                                            <img src="./imgs/heart_box.png" />
                                        </li>
                                        <li class="more-sugar-font"><a href="/~s2647596/analysis.html">return</a></li>`
                // window.location.reload(true)
            }
        }
    
        // Call the async function
        getStat(find_prev_seq, previous_seq_el, seq_id_url);
        getStat(upload_file, file_el, upload_url);
    </script>
</body>
</html>